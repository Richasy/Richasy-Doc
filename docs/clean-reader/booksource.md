---
sidebar_position: 3
---

# 书源定义

尽管已经有 [阅读](https://alanskycn.gitee.io/teachme/Rule/source.html) 珠玉在前，但通过查看其源码，它只有在 JAVA 环境中才能发挥出全部实力，.NET 强行兼容会给我的心智带来巨大负担，所以在经过种种尝试后，我还是选择创建一个功能也许没那么丰富，但是没有平台兼容性问题的书源规则。

## 书源前置知识

1. 你需要对 JSON 有着基本的了解
2. 你需要有一定的 **正则表达式** 基础
3. 你需要对 Javascript 的 DOM selector 有一定的基础了解

## 书源基本定义

整个书源的概览数据结构如下：

```json
{
  "Id": "",
  "Name": "",
  "WebUrl": "",
  "Charset": "",
  "IsBookDetailEnabled": true,
  "IsExploreEnabled": true,

  "Search": {},
  "BookDetail": {},
  "Chapter": {},
  "ChapterContent": {},
  "Explore": {}
}
```

### 书源标识定义

| **Id** | String |
| ------ | ------ |

这是书源的标识符。一个书源对应一个书源 JSON 文件，并放置在书库目录下的 `.booksource` 文件夹中。其 `Id` 必须和文件名相同，比如我要为 **某某小说网** 创建书源，规定其 `Id` 为 **moumou**，那么文件名就必须是 `moumou.json`。

这是因为干净阅读应用会通过枚举 `.booksource` 文件夹下的文件来创建书源，在目录下，每一个书源的名称都应该是唯一的，以保证书源和文件的一一对应。

| **Name** | String |
| -------- | ------ |

书源的名称，应为可读文本，在应用的书源管理页面，将会将该值作为书源的名称显示在界面上。

| **WebUrl** | String |
| ---------- | ------ |

书源所对应的网址。干净阅读对书源的解析是基于网页的，所以这里填写的是对应资源站的首页网址。用户也可以在书源管理页面通过点击书源来跳转到对应的网站。

| **Charset** | String |
| ----------- | ------ |

字符集。虽然默认是 UTF-8，但并不是所有的网站都是 UTF-8 的字符集，比如有些中文站点的字符集就是 GB2312 , 所以你需要确定对应网站所采用的字符集，以免出现乱码的情况。所有字符集可选值在 [这里](https://docs.microsoft.com/en-us/dotnet/api/system.text.encoding?view=net-6.0#list-of-encodings)，请首先确认对应字符集是 `.NET Framework support` 或 `.NET 5 and later support`，然后输入对应条目的 `Name` 值。

| **IsBookDetailEnabled** | Boolean |
| ----------------------- | ------- |

是否支持获取书籍的详情。这对应着书源是否支持解析书站中的书籍详情页。尽管干净阅读中并没有特定的页面用来显示书籍详情，但是当无法从搜索结果或者探索模块中获取完整的书籍信息时（比如缺少书籍介绍，或者缺失封面），就可以通过书籍详情解析来补全缺失内容。

| **IsExploreEnabled** | Boolean |
| -------------------- | ------- |

是否支持 `发现` 这一扩展模块。即表示是否支持显示书站中的分类或榜单。对于不支持发现模块的书源，在干净阅读的探索&发现页面中将不予显示。

### 书源内的书籍信息通用结构

对于一本书而言，所获取到的属性是一定的。比如书名、作者、更新时间等。而搜索/发现等模块会获取到一个书籍列表，它们共享一个书籍属性解析规则定义，这就是所谓的 **书籍信息通用结构**，数据结构如下：

```json
{
    "Range": "",
    "Repair": [],
    "Replace": [],
    "BookName": {},
    "BookUrl": {},
    "BookCover": {},
    "BookAuthor": {},
    "BookDescription": {},
    "BookStatus": {},
    "LastChapterTitle": {},
    "LastChapterUrl": {},
    "Category": {},
    "Tag": {},
    "UpdateTime": {}
}
```

:::tip
该结构将作为 `搜索`，`发现` 和 `书籍详情` 的基础结构。在实际使用中，你需要的属性可能无法在某一个模块内找齐。比如在 `搜索` 模块中你可能找不到封面，因为网站没有提供。那么在 `搜索` 模块中，你可以不要 `BookCover` 属性，而在 `书籍详情` 模块中写。
:::

| **Range** | String |
| --------- | ------ |

这是一个初始搜索范围，它是选择器表达式，也就是 javascript 中的 [document.querySelector()](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/querySelector) 的参数。通过该范围选出来的元素将作为一个根元素，所有子属性都会在这个根元素内查询元素。

| **Repair** | Array<[Repair](#repair)> |
| ---------- | ------------------------ |

一组修复规则，关于修复规则，详情请查看 [Repair](#repair) 的介绍。如果不需要，可以留空。

| **Replace** | Array<[Replace](#replace)> |
| ----------- | -------------------------- |

一组替换规则，关于替换规则，详情请查看 [Replace](#replace) 的介绍。如果不需要，可以留空。

*其它属性*

| 属性                 | 类型                    | 说明                                                                                  |
| -------------------- | ----------------------- | ------------------------------------------------------------------------------------- |
| **BookName**         | [Attribute](#attribute) | 书名的查询规则                                                                        |
| **BookUrl**          | [Attribute](#attribute) | 书籍地址（即书籍详情页网址）规则，要求是完整的 Url                                    |
| **BookCover**        | [Attribute](#attribute) | 封面图片地址规则，要求是完整的 Url                                                    |
| **BookAuthor**       | [Attribute](#attribute) | 书籍作者规则                                                                          |
| **BookDescription**  | [Attribute](#attribute) | 书籍描述规则                                                                          |
| **BookStatus**       | [Attribute](#attribute) | 书籍状态规则，通常应将其通过 Replace 规则或 Repair 规则调整为 `连载` 或 `完结` 两种值 |
| **LastChapterTitle** | [Attribute](#attribute) | 最新章节标题规则                                                                      |
| **LastChapterUrl**   | [Attribute](#attribute) | 最新章节地址规则，不要求其是完整的 Url                                                |
| **Category**         | [Attribute](#attribute) | 书籍分类规则，标识书籍所属的分类                                                      |
| **Tag**              | [Attribute](#attribute) | 标签规则，可以获取书籍的标签，应尽量让其以半角逗号 (`,`) 作为分隔符                   |
| **UpdateTime**       | [Attribute](#attribute) | 更新时间规则，应尽量保持其时间字符串的纯洁性，不要混杂进其它的无关字符                |

## 书源中的模块

概括来说，书源除了基本定义外，主要包含以下模块

- **Search**：搜索模块，用于根据关键词进行搜索，支持网页解析和 API 请求两种方式。
- **BookDetail**：书籍详情模块，用于解析书籍详情页，获取其它模块缺失的内容。
- **Chapter**：目录模块，用于解析书籍的目录，以获取完整的章节索引。
- **ChapterContent**：章节内容模块，用于解析具体的章节内容，支持下一页请求，仅支持网页解析。
- **Explore**：发现模块，你可以预设一组分类，应用会根据你给定的规则进行解析，显示每个分类下的书籍列表。

### 搜索

搜索模块的主要数据结构如下：

```json
{
    // 包含书籍信息通用结构
    "SearchUrl": "",
    "Request": {},
    "NeedDetail": false
}
```

***这个数据结构是省略版，省略的属性在 [书籍信息通用结构](#书源内的书籍信息通用结构) 中定义***

:::tip
搜索模块使用 `{{keyword}}` 作为变量，用户的输入会替换该占位符，作为实际发送的内容。

举例而言，如果你定义的 `SearchUrl` 是 **https://xxx.com/search?key={{keyword}}**，那么当用户输入 `小说名` 时，最后请求的网址就是 **https://xxx.com/search?key=小说名**
:::

| **SearchUrl** | String |
| ------------- | ------ |

表示搜索页面所对应的地址。有些网站通过查询参数来进行搜索，有的网站则通过 API 请求，无论哪一种，你都需要将网站中的实际发生请求的搜索页面的网址赋值给该属性。

| **Request** | [Request](#request) |
| ----------- | ------------------- |

表示搜索请求方式，具体定义可以参照 [Request](#request)，当网页是通过查询参数进行搜索时，可以不用写 Request 属性（除非对请求头有特殊要求）。

| **NeedDetail** | Boolean |
| -------------- | ------- |

这是一个非常特殊的字段，表示是否对所获取的书籍条目进行进一步请求（调用书籍详情模块），获取书籍的详细信息。

这是因为有时候从搜索结果拿到的条目缺少必要的信息（比如封面，或者最新章节），为了确保结果的完整性，所以需要进一步请求对应书籍条目的详情页面来获取完整的信息。

:::warning
将该属性设置为 `true`，应用会在执行完搜索请求后，将所有的搜索结果加入请求队列，获取所有搜索结果的详细信息，然后再显示结果。所以应用的请求时间会变长，同时瞬时内存占用会增加，请确保你有必要使用该属性。
:::

### 发现

发现模块的主要数据结构如下：

```json
{
    // 包含书籍信息通用结构
    "Categories": [],
    "Request": {},
    "NeedDetail": false
}
```

***这个数据结构是省略版，省略的属性在 [书籍信息通用结构](#书源内的书籍信息通用结构) 中定义***

#### Category

这是分类结构，一个发现模块可以包含多个分类，就好比网站中划分的诸如 `玄幻`，`仙侠` 等类别，它的结构很简单，如下所示：

```json
{
    "Name": "",
    "Url": ""
}
```

一个表示分类的名称，另外一个表示分类所对应的网址（需要完整 Url）。

---

| **Categories** | Array<[Category](#category)> |
| -------------- | ---------------------------- |

表示发现模块内的分类列表，这是一组键值对，每一个分类所对应的 HTML 结构应是一致的，因为它们不具备独立的解析规则，将由发现模块的规则进行统一解析。

| **Request** | [Request](#request) |
| ----------- | ------------------- |

表示搜索请求方式，具体定义可以参照 [Request](#request)，当网页是通过查询参数进行搜索时，可以不用写 Request 属性（除非对请求头有特殊要求）。

| **NeedDetail** | Boolean |
| -------------- | ------- |

这是一个非常特殊的字段，表示是否对所获取的书籍条目进行进一步请求（调用书籍详情模块），获取书籍的详细信息。

这是因为有时候从搜索结果拿到的条目缺少必要的信息（比如封面，或者最新章节），为了确保结果的完整性，所以需要进一步请求对应书籍条目的详情页面来获取完整的信息。

:::warning
将该属性设置为 `true`，应用会在执行完搜索请求后，将所有的搜索结果加入请求队列，获取所有搜索结果的详细信息，然后再显示结果。所以应用的请求时间会变长，同时瞬时内存占用会增加，请确保你有必要使用该属性。
:::

### 书籍详情

书籍详情模块和 [书籍信息通用结构](#书源内的书籍信息通用结构) 的数据结构一致。它进行解析的前置条件是获取到包含有书籍详情地址的书籍。

:::tip
`搜索` 和 `发现` 两个模块互不干涉，但是它们都可以从 `书籍详情` 模块中获得补充。
:::

### 目录

目录规则的数据结构如下：

```json
{
    "Range": "",
    "Repair": [],
    "Replace": [],
    "Title": {},
    "Url": {},
    "IsChildFiltered": false,
    "ChildSelector": ""
}
```

| **Range** | String |
| --------- | ------ |

确定获取目录的 DOM 范围，和 [书籍信息通用结构](#书源内的书籍信息通用结构) 中的 `Range` 属性含义相同。

| **Repair** | Array<[Repair](#repair)> |
| ---------- | ------------------------ |

文本修复规则，和 [书籍信息通用结构](#书源内的书籍信息通用结构) 中的 `Repair` 属性含义相同。但需要注意的是，由于目录的特殊性，Repair 条目的 Field 属性的可选值只有 `0` 或 `1` 即只有 标题 或者 URL 可以被调整。

:::tip
对于目录模块中的 `Repair` 规则来说，可以使用一个特殊变量，它是 `ORIGIN_URL`。它表示目录所对应的书籍地址，由于书籍地址是可变的，所以将其暴露出来以便使用。`ORIGIN_URL` 仅能作为 Repair 的 `Value` 值，不能与其它字符混用。
:::

| **Replace** | Array<[Replace](#replace)> |
| ----------- | -------------------------- |

文本替换规则，和 [书籍信息通用结构](#书源内的书籍信息通用结构) 中的 `Replace` 属性含义相同。但需要注意的是，由于目录的特殊性，Replace 条目的 Field 属性的可选值只有 `0` 或 `1` 即只有 标题 或者 URL 可以被调整。

| **Title** | [Attribute](#attribute) |
| ----------- | -------------------------- |



## 通用数据结构

### FieldType

表示字段类型，目前应用规定了以下几种字段类型：

| 名称             | 说明         | 值  |
| ---------------- | ------------ | --- |
| Title            | 书名或标题   | 0   |
| Url              | 地址链接     | 1   |
| BookCover        | 书籍封面     | 2   |
| BookAuthor       | 书籍作者     | 3   |
| BookDescription  | 简介         | 4   |
| BookStatus       | 书籍状态     | 5   |
| LastChapterTitle | 最新章节标题 | 6   |
| LastChapterUrl   | 最新章节地址 | 7   |
| Category         | 书籍分类     | 8   |
| Tag              | 书籍标签     | 9   |
| UpdateTime       | 书籍更新时间 | 10  |

### Repair

这是一种修复规则，可以在指定 [FieldType](#fieldtype) 的左/右补充内容。

比如对于封面规则来说，网页常常会提供一个不包含网址的相对链接，此时可以通过修复规则补全网址，以避免应用无法识别链接。

其数据结构如下：

```json
{
    "Field": 0,
    "Position": "",
    "Value": ""
}
```

| **Field** | [FieldType](#fieldtype) |
| --------- | ----------------------- |

表示对应的字段，在这里你需要填上对应字段的值，以确定修复规则会应用于哪一个字段上。

| **Position** | String |
| ------------ | ------ |

可选值为 `l` 和 `r`，分别表示左和右，表示修复规则是应用于字段的左侧还是右侧。

| **Value** | String |
| --------- | ------ |

需要补充的内容，是一个静态值，不包含变量。

### Replace

这是一种替换规则，用于将指定 [FieldType] 中的匹配内容替换为其它内容。

其数据结构如下：

```json
{
    "Field": 0,
    "Old": "",
    "New": ""
}
```

| **Field** | [FieldType](#fieldtype) |
| --------- | ----------------------- |

表示对应的字段，在这里你需要填上对应字段的值，以确定替换规则会应用于哪一个字段上。

| **Old** | String |
| ------- | ------ |

需要匹配的内容的正则表达式。

| **Value** | String |
| --------- | ------ |

替换的新内容，是一个静态值，不包含变量。

### Request

表示网络请求的配置，可以用在 [搜索](#搜索) 或 [发现](#发现) 模块中。

```json
{
    "Method": "",
    "Body": "",
    "DataType": "",
    "Headers": [
        {
            "Key": "",
            "Value": ""
        }
    ]
}
```

| **Method** | String |
| ---------- | ------ |

表示请求方式，目前应用支持的网络请求方式可选值为 `POST` 和 `GET`，请按需取用。

| **Body** | String |
| -------- | ------ |

表示请求体，对于 **搜索模块** 来说，你可以用 {{keyword}} 占位符来表示用户的输入文本。

| **DataType** | String |
| ------------ | ------ |

数据请求的类型，目前支持三种类型：

- `form`: 表示表单请求，对应的是编码格式是 `application/x-www-form-urlencoded`
- `json`: 表示 JSON 结构数据请求，对应的编码格式是 `application/json`
- `raw`: 表示文本数据请求，对应的编码格式是 `text/xml`

| **Headers** | Array |
| ----------- | ----- |

表示请求头，如果该请求需要特殊的请求头，你可以通过键值对的方式规定执行请求所需要的请求头。


### Attribute

这是基本的解析规则单元。我们需要从网页中解析出各种各样的属性，比如书名，作者等，所以我们需要为每个属性确定一种解析的规则。

其数据结构如下：

```json
{
    "Type": "",
    "Rule": "",
    "Filter": ""
}
```

| **Type** | String |
| -------- | ------ |

我们最终会通过 `Rule` 属性拿到一个 DOM 元素，`Type` 属性就是规定我们获取这个 DOM 元素中的哪个部分。举例来说，当我们获取到一个章节索引后（a 标签，超链接），如果我们需要获取章节标题，那么 Type 就为 `text`，以获取标签内的文本内容。如果要获取对应链接，Type 就为 `href`，以获取 a 标签的 href 属性。

| **Rule** | String |
| -------- | ------ |

表示选择器表达式，也就是 javascript 中的 [document.querySelector()](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/querySelector) 的参数。它会在上层规则确定的搜索范围内找到指定的元素，选择器的行为和 javascript 中的行为一致，你传入的字符串需要符合其语法规范，对于需要引号的地方，尽量使用单引号。

| **Filter** | String |
| ---------- | ------ |

这是一种过滤规则，是正则表达式。如果筛选后的内容中有不需要的东西，可以通过正则表达式匹配的方式进行一次简单的过滤。如果有较为复杂的过滤规则，请在父容器的 [Replace](#replace) 数组内定义替换规则，将匹配内容替换为空字符串。